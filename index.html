<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Mothership Down!</title>
    <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
    <link rel="stylesheet" href="./assets/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="./assets/stylesheets/reset.css" />
    <link rel="stylesheet" type="text/css" href="./assets/stylesheets/mainpage.css" />
    <script>
      document.addEventListener('DOMContentLoaded', () => {

        //run once
        initialize();


        if (!window.playing) {
          ctx_ui.fillStyle = "White";
          ctx_ui.font = "30px Calibri";
          ctx_ui.fillText("Instructions:", 50, 100);
          ctx_ui.font = "20px Calibri";
          ctx_ui.fillText("Use arrow keys to move cannon's position.", 50, 130);
          ctx_ui.fillText("Shoot puny Earthlings with spacebar.", 50, 150);
          ctx_ui.fillText("Press Enter to Begin.", 50, 170);
          //press enter event
          document.addEventListener('keydown', (e) => {

            if (e.keyCode === 13) {
              e.preventDefault();
              ctx_ui.clearRect(0,0, 600, 400);
              window.playing = true;
              setAllIntervals();
            }
          });
        }

        function initialize() {
            //initialize canvas vars
          window.canvas = document.getElementById('canvas');
          window.canvasBG = document.getElementById('canvas-BG');
          window.canvasUI = document.getElementById('canvas-UI');
          window.ctx = canvas.getContext('2d');
          window.ctx_bg = canvasBG.getContext('2d');
          window.ctx_ui = canvasUI.getContext('2d');

          //initialize images
          window.imageRepo = new function() {
            this.mothershipImg = new Image();
            this.mothershipImg.src = "./assets/images/mainship.png";

            this.spaceBG = new Image();
            this.spaceBG.src = "./assets/images/maxresdefault.jpg";

            this.shieldSheet= new Image();
            this.shieldSheet.src = "./assets/images/shieldsheet.png";

            this.healthbar = new Image();

            this.beacon = new Image();

            this.powerPanel = new Image();
          }

          window.parallax = {
            posX: 0,
            posY: 0,
            width: 600,
            height: 400,
            speed: 0.2,
            drawSelf: function() {
              ctx_bg.clearRect(this.posX, this.posY, this.width, this.height);
              this.posX += this.speed;
              if (this.posX > this.width) { this.posX = 0; }
              if (this.posX > 0) { ctx_bg.drawImage(imageRepo.spaceBG,
                this.posX - this.width + 1, this.posY, this.width, this.height); }
              ctx_bg.drawImage(imageRepo.spaceBG,
              this.posX, this.posY, this.width, this.height)
            }

          }

          //initialize mothership
          window.mothership = {
            posX: 60,
            posY: 318,
            width: 470,
            height: 200,
            tag: "playerShip",
            hullHP: 100,
            shieldHP: 100,
            drawSelf: function() {
              ctx.drawImage(imageRepo.mothershipImg,
              this.posX, this.posY, this.width, this.height)
            },
            drawShield: function() {
              ctx.drawImage(imageRepo.shieldSheet,
              0, 0, 300, 100,
              this.posX - 20, this.posY - 60, this.width, this.height)
            }
          }

          //initialize cannon vars
          window.cannon = {
            posX: canvas.width/2,
            posY: canvas.height - 70,
            width: 15,
            height: 30,
            hp: 10,
            tag: "playerCannon",
            drawSelf: function() {
              ctx.fillStyle = "gray";
              ctx.fillRect(this.posX, this.posY, this.width, this.height);
            },
            screenResets: function() {
              if (cannon.posX < window.screenResets.left)
              cannon.posX = 580;
              if (cannon.posX > window.screenResets.right)
              cannon.posX = 0;
            }
          };



          //helper methods-----------------------

          //max is not included
          window.randomInt = function(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min)) + min;
          }


          //used with screen logic
          window.screenResets = {
            top: 0,
            bottom: 400,
            left: 0,
            right: 600
          }

          //list of bullets on screen
          window.bulletList = [];
          //list of enemies on screen
          //max is currently 12
          window.enemyList = [];
          //List of player cannons and mothership
          window.playerList = [];
          playerList.push(cannon);
          playerList.push(mothership);
          window.playing = false;
        }

        //main bullet script
        function bullet(x, y, velocity, width, height) {
            this.alive = false;
            this.defaultWidth = 6;
            this.defaultHeight = 12;
            this.defaultVelocity = 5;
            this.tag = "";
            //decide the tag on spawn

            this.spawn = function(x, y, velocity, width, height, tag) {
              this.posX = x;
              this.posY = y;
              this.velocity = velocity;
              this.width = width;
              this.height = height;
              this.alive = true;
              this.tag = tag;
            }

            this.drawSelf = function() {

              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              ctx.fillStyle = "orange";
              ctx.fillRect(this.posX, this.posY, this.width, this.height);
            }

            function checkIntersect(obj1, obj2) {
              if (obj1.posX < obj2.posX + obj2.width &&
                obj1.posX + obj1.width > obj2.posX &&
                obj1.posY < obj2.posY + obj2.height &&
                obj1.height + obj1.posY > obj2.posY) {
                  return true;
              } else {
                return false;
              }
            }

            this.checkCollision = function(otherObjects) {
              if (this.alive) {

                for (let i = 0; i < otherObjects.length; i++) {

                  if (checkIntersect(this, otherObjects[i])) {
                    if (otherObjects[i].tag === "enemyShip") {
                      otherObjects[i].destroy();
                      otherObjects.splice(i, 1);
                      this.destroy();
                    } else {
                      otherObjects[i].hp -= 10;
                      this.destroy();
                    }

                  }
                }

              }
            };

            this.destroy = function() {
              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              this.alive = false;
              this.posX = -1000;
              this.posY = -1000;
            }
          }

          //main enemy script
          class enemyShip {
            constructor(x, y, velocityX, velocityY, width, height, tag) {
              this.posX = x;
              this.posY = y;
              this.velocityX = velocityX;
              this.velocityY = velocityY;
              this.width = width;
              this.height = height;
              this.tag = tag;
              this.alive = true;
              this.cooldown = false;


              this.shoot = this.shoot.bind(this);
              this.cooldownreset = this.cooldownreset.bind(this);
            }

            drawSelf() {
              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              ctx.fillStyle = "white";
              ctx.fillRect(this.posX, this.posY, this.width, this.height);
            }

            moveHorizontal() {
              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              ctx.fillStyle = "white";
              if (randomInt(0,2) === 0) {
                this.posX += 30;
              } else {
                this.posX -= 30;
              }
              this.screenResets();
              ctx.fillRect(this.posX, this.posY, this.width, this.height);
            }

            moveVertical() {
              let chancetoMoveForward = randomInt(0,10);
              let forwardVelocity = 0;
              if (chancetoMoveForward >= 9) {
                forwardVelocity = 30;
              }
              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              ctx.fillStyle = "white";
              this.posY += forwardVelocity;
              ctx.fillRect(this.posX, this.posY, this.width, this.height);
            }

            cooldownreset() {
              this.cooldown = false;
            }


            shoot(source) {
              if (this.cooldown) {
                let cooldowntimer = randomInt(500, 8000);
                setTimeout(this.cooldownreset, cooldowntimer)
              } else {
                let nb = new bullet(
                  source.posX + 5, source.posY, 10, 6, 12);
                  nb.spawn(source.posX + 7, source.posY + 28, 10, 6, 12, "enemy1");
                  nb.drawSelf();
                  bulletList.push(nb);
                  this.cooldown = true;
              }
              console.log(bulletList);
            }

            screenResets() {
              if (this.posX < 60)
              this.posX = 60;
              if (this.posX > 520)
              this.posX = 520;
              if (this.posY > 400)
              this.destroy();
            }


            destroy() {
              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              this.alive = false;
              this.posX = -1000;
              this.posY = -1000;
            }

          }

          //if bulletList is not empty, run this every frame
          //this is problematic because updating the pos needs to be seperated from drawing
          //if they're together, bullet stops executing velocity before it can become invalid
          //and undrawable
          function updateBullets() {
            for (let i = 0; i < bulletList.length; i++) {

              if (bulletList[i].alive) {
                //if bullet is alive and still within play area...
                if (bulletList[i].posY > 0 && bulletList[i].posY < 400) {
                  ctx.clearRect(bulletList[i].posX, bulletList[i].posY,
                    bulletList[i].width, bulletList[i].height);
                  ctx.fillStyle = "orange";
                    if (bulletList[i].tag === "player") {
                      //check whether bullet is hitting enemy
                      bulletList[i].posY -= 5;
                      bulletList[i].checkCollision(enemyList);
                    } else {
                      //check if bullet is hitting player unit
                      bulletList[i].posY += 2;
                      bulletList[i].checkCollision(playerList);
                    }
                  ctx.fillRect(bulletList[i].posX, bulletList[i].posY,
                  bulletList[i].width, bulletList[i].height);

                } else {
                  //if pos is going off, delete it
                  //splice removes from i position, 1 thing
                  bulletList[i].alive = false;
                  bulletList[i].destroy();
                  bulletList.splice(i, 1);
                }
              } else {
                //if its in the list but not alive...
                bulletList[i].destroy();
                bulletList.splice(i, 1);
              }
            }

          }
          function enemyUpdate() {
            for (let i = 0; i < enemyList.length; i++) {
              if (enemyList[i].alive) {
                enemyList[i].moveHorizontal();
                enemyList[i].moveVertical();
              } else {
                //get rid of enemy from list
                enemyList.splice(i, 1);
              }
            }
          }

          function enemyAttack() {
            for (let i = 0; i < enemyList.length; i++) {
              if (enemyList[i].alive) {
                enemyList[i].shoot(enemyList[i]);
              }

            }
          }

          function randomSpawn() {
            if (enemyList.length < 12) {
              let randomX = randomInt(0, 10);
              let spawnXs = [60, 110, 160, 220, 270, 320, 370, 420, 470, 520]
              let newenemy = new enemyShip(spawnXs[randomX], 30,
                30, 30, 30, 30, "enemyShip");
                  newenemy.drawSelf();
                  enemyList.push(newenemy);

            }
          }
        //end initialize --------------------------
        function setAllIntervals() {
          // run every frame
          window.setInterval(update, 16);
          window.setInterval(draw, 16);

          //custom interval updates
          window.setInterval(randomSpawn, 3000);
          window.setInterval(enemyUpdate, 500);
          window.setInterval(enemyAttack, randomInt(500, 4000));

        }

        if (window.playing) {


          function update() {
            if (bulletList.length > 0)
            updateBullets();
            console.log("continuous updates");
          }



          function draw() {
            //draw bg
            parallax.drawSelf();
            //draw mothership
            mothership.drawSelf();
            mothership.drawShield();

            //draw main cannon
            cannon.drawSelf();

            //draw active enemies
            for (let i = 0; i < enemyList.length; i++) {
              enemyList[i].drawSelf();
            }
            console.log("continuous draws");
          }
          //keypress handler
          //this is also basically the update() for ship
          document.addEventListener('keydown', (e) => {
            ctx.fillStyle = 'gray';
            switch (e.keyCode) {

              case 37:
              //left
              ctx.clearRect(cannon.posX, cannon.posY, cannon.width, cannon.height);
              cannon.posX -= 20;
              cannon.screenResets();
              ctx.fillRect(cannon.posX, cannon.posY, cannon.width, cannon.height);
              break;
              case 39:
              //right
              ctx.clearRect(cannon.posX, cannon.posY, cannon.width, cannon.height);
              cannon.posX += 20;
              cannon.screenResets();
              ctx.fillRect(cannon.posX, cannon.posY, cannon.width, cannon.height);
              break;
              case 32:
              //spacebar shoot
              e.preventDefault();
              let nb = new bullet(
              cannon.posX + 5, cannon.posY, 10, 6, 12);
              nb.spawn(cannon.posX + 5, cannon.posY, 10, 6, 12, "player");
              nb.drawSelf();
              bulletList.push(nb);
              console.log(bulletList);
              break;
              //add another case for pause if time allows
              default:
            }
          })

        }//end of window.playing

      })//end of DOMContentLoaded
    </script>
  </head>
  <body>
    <div class="content-container">
      <h1>MOTHERSHIP DOWN</h1>
      <div class="game-viewport">
          <canvas id="canvas-BG" height="400" width="600"></canvas>
          <canvas id="canvas" height="400" width="600" tabindex='1'></canvas>
          <canvas id="canvas-UI" height="400" width="600"></canvas>

      </div>
      <div class="icons">
        <a href="#"><i id="linker"class="fa fa-home fa-2x"></i></a>
        <a href="#"><i id="linker"class="fa fa-linkedin fa-2x"></i></a>
        <a href="#"><i id="linker"class="fa fa-github fa-2x"></i></a>
        <a href="#"><i id="linker"class="fa fa-envelope fa-2x"></i></a>
      </div>
    </div>
    <p>&copy; 2017 Hein Htet Pyi Soe. All Rights Reserved.</p>
  </body>
</html>
