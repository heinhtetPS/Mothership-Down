<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Mothership Down!</title>
    <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
    <link rel="stylesheet" href="./assets/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="./assets/stylesheets/reset.css" />
    <link rel="stylesheet" type="text/css" href="./assets/stylesheets/mainpage.css" />
    <script>
      document.addEventListener('DOMContentLoaded', () => {

        //run once
        initialize();

        function initialize() {
            //initialize canvas vars
          window.canvas = document.getElementById('canvas');
          window.canvasBG = document.getElementById('canvas-BG');
          window.canvasUI = document.getElementById('canvas-UI');
          window.ctx = canvas.getContext('2d');
          window.ctx_bg = canvasBG.getContext('2d');
          window.ctx_ui = canvasUI.getContext('2d');

          //initialize images
          window.imageRepo = new function() {

            this.allimages = 5;
            this.loaded = 0;
            this.mothershipImg = new Image();
            this.mothershipImg.src = "./assets/images/altship.png";
            // this.mothershipImg.onload = () => {
            //   ctx.drawImage(this.mothershipImg,
            //   60, 308, 500, 220);
            //   // 60;
            //   // this.poxY = 318;
            //   // this.width = 470;
            //   // this.height = 200;
            //   //original 194 x 103
            // }

            this.cannonSheet = new Image();
            this.cannonSheet.src = "./assets/images/cannonsheet.png"
            // this.cannonSheet.onload = () => {
            //   ctx.drawImage(imageRepo.cannonSheet,
            //     0, 0, 90, 220,
            //     100, 100, 30, 80);
            // };
            //first cannon cooords 0, 0, 90, 220,

            this.spaceBG = new Image();
            this.spaceBG.src = "./assets/images/maxresdefault.jpg";
            // this.spaceBG.onload = () => {}

            this.shieldSheet= new Image();
            this.shieldSheet.src = "./assets/images/shieldsheet.png";
            // this.shieldSheet.onload = () => {
            //   ctx.drawImage(this.shieldSheet,
            //   0, 0, 300, 100,
            //   40, 258, 470, 200);
            //   // ctx.drawImage(imageRepo.shieldSheet,
            //   // 0, 0, 300, 100,
            //   // 60 - 20, 318 - 60, 470, 200);
            // }

            this.enemy1 = new Image();
            this.enemy1.src = "./assets/images/enemy1.png";

            this.explosion = new Image();
            this.explosion.src = "./assets/images/explosheet.png";

            this.arrows = new Image();
            this.arrows.src = "./assets/images/arrows.png";
            this.arrows.onload = () => {
              ctx_ui.drawImage(this.arrows,
              90, 190, 50, 50);
            }

            this.spacebar = new Image();
            this.spacebar.src = "./assets/images/spacebar.png";
            this.spacebar.onload = () => {
              ctx_ui.drawImage(this.spacebar,
              310, 235, 100, 50);
            }
            this.healthbar = new Image();

            this.beacon = new Image();

            // function imageLoaded() {
            //   numLoaded++;
            //   if (numLoaded === numImages) {
            //
            //   }
            // }
            this.powerPanel = new Image();

          }//end of image repo

          //helper methods-----------------------

          //max is not included
          window.randomInt = function(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min)) + min;
          }
          //used with screen logic
          window.screenResets = {
            top: 0,
            bottom: 400,
            left: 0,
            right: 600
          }
          //list of bullets on screen
          window.bulletList = [];
          //list of enemies on screen
          //max is currently 12
          window.enemyList = [];
          //list of explosions
          window.explosionList = [];
          //List of player cannons and mothership
          window.playerList = [];
          window.playing = false;
        }//end of initialize

        if (!window.playing) {
          ctx_bg.fillRect(0,0,600,400);
          ctx_ui.fillStyle = "White";
          ctx_ui.font = '8px "Press Start 2P"';
          ctx_ui.fillText("You are the last remaining survivors of your species,", 50, 40);
          ctx_ui.fillText("thrust into the void of space...", 50, 50);
          ctx_ui.fillText("...after your homeworld was ravaged by environmental destruction", 50, 60);
          ctx_ui.fillText("your sensors have identified a nearby habitable planet...", 50, 80);
          ctx_ui.fillText("The third planet in the Milky Way Galaxy...", 50, 90);
          ctx_ui.font = '10px "Press Start 2P"';
          ctx_ui.fillText("Use       to move cannon's position.", 50, 240);
          ctx_ui.fillText("Shoot puny Earthlings with      .", 50, 260);
          ctx_ui.fillText("Press Enter to Begin.", 50, 320);

          //press enter event
          document.addEventListener('keydown', (e) => {

            if (e.keyCode === 13) {
              e.preventDefault();
              ctx_ui.clearRect(0,0, 600, 400);
              window.playing = true;
              setAllIntervals();
            }
          });
        }





        //mothership def
        class Mothership {
          constructor() {
            this.posX = 60;
            this.poxY = 318;
            this.width = 470;
            this.height = 200;
            this.tag = "mothership";
            this.hullHP = 100;
            this.shieldHP = 100;

            this.drawSelf = this.drawSelf.bind(this);
            this.drawShield = this.drawShield.bind(this);
            this.drawUI = this.drawUI.bind(this);
          }

          drawSelf() {
            // ctx.drawImage(imageRepo.mothershipImg,
            // this.posX, this.posY, this.width, this.height);
            ctx.fillStyle = "purple";
            ctx.fillRect(this.posX, this.posY, this.width, this.height);
          }

          drawShield() {
            // ctx.drawImage(imageRepo.shieldSheet,
            // 0, 0, 300, 100,
            // this.posX - 20, this.posY - 60, this.width, this.height);
            ctx.fillStyle = "yellow";
            ctx.fillRect(this.posX - 20, this.posY - 60, this.width, this.height);
          }
          drawUI() {
            //this doesn't work at all
            // ctx_ui.font = "30px Calibri";
            // ctx_ui.fillText(`Shield: #{this.shieldHP}`, 50, 50);
          }
        }
        //draw player stuff
        const mothership = new Mothership();
        playerList.push(mothership);


        //initialize cannon vars
        class Cannon {
          constructor() {
            this.posX = canvas.width/2;
            this.posY = canvas.height - 90;
            this.width = 30;
            this.height = 80;
            this.alive = true;
            this.tag = "playerCannon";
            this.deathtimer = 0;

            this.drawSelf = this.drawSelf.bind(this);
            this.screenResets = this.screenResets.bind(this);
            this.destroy = this.destroy.bind(this);
            this.respawn = this.respawn.bind(this);
          }

          drawSelf() {
            ctx.drawImage(imageRepo.cannonSheet,
            0, 0, 90, 220,
            this.posX, this.posY, this.width, this.height);
          }
          screenResets() {
            if (cannon.posX < window.screenResets.left)
            cannon.posX = 580;
            if (cannon.posX > window.screenResets.right)
            cannon.posX = 0;
          }

          respawn() {
            this.alive = true;
            ctx.drawImage(imageRepo.cannonSheet,
            0, 0, 90, 220,
            this.posX, this.posY, this.width, this.height);
          }

          destroy() {
            let newexplo = new Explosion(this);
            newexplo.drawSelf();
            explosionList.push(newexplo);
            ctx.clearRect(this.posX, this.posY, this.width, this.height);
            this.alive = false;
          }
        }
        let cannon = new Cannon();
        playerList.push(cannon);

        class Parallax {
          constructor() {
            this.posX = 0;
            this.posY = 0;
            this.width = 600;
            this.height = 400;
            this.speed = 0.2;

            this.drawSelf = this.drawSelf.bind(this);
          }

          drawSelf() {
            ctx_bg.clearRect(this.posX, this.posY, this.width, this.height);
            this.posX += this.speed;
            if (this.posX > this.width) { this.posX = 0; }
            if (this.posX > 0) { ctx_bg.drawImage(imageRepo.spaceBG,
              this.posX - this.width + 1, this.posY, this.width, this.height); }
            ctx_bg.drawImage(imageRepo.spaceBG,
            this.posX, this.posY, this.width, this.height)
          }
        }

        //main bullet script
        function bullet(x, y, velocity, width, height) {
            this.alive = false;
            this.defaultWidth = 6;
            this.defaultHeight = 12;
            this.defaultVelocity = 5;
            this.tag = "";
            //decide the tag on spawn

            this.spawn = function(x, y, velocity, width, height, tag) {
              this.posX = x;
              this.posY = y;
              this.velocity = velocity;
              this.width = width;
              this.height = height;
              this.alive = true;
              this.tag = tag;
            }

            this.drawSelf = function() {

              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              ctx.fillStyle = "orange";
              ctx.fillRect(this.posX, this.posY, this.width, this.height);
            }

            //I plugged in the numbers from the actual positions of the
            //bullet and mothership and it returned true
            this.checkIntersect = function(otherobj) {
              if (this.posX < otherobj.posX + otherobj.width &&
                this.posX + this.width > otherobj.posX &&
                this.posY < otherobj.posY + otherobj.height &&
                this.height + this.posY > otherobj.posY) {
                  return true;
              } else {
                return false;
              }
            }

            this.checkCollision = function(otherObjects) {
              //player bullets ONLY check against enemy list
              //enemy bullets ONLY check against player objects
              if (this.alive) {

                for (let i = 0; i < otherObjects.length; i++) {
                  //it gets in here but never fulfills check intersect with Mship
                  // console.log("now checking for collision");
                    //only for player

                  if (otherObjects[i].alive) {

                    if (this.checkIntersect(otherObjects[i])) {
                      debugger
                      if (otherObjects[i].tag === "enemyShip") {
                        otherObjects[i].destroy();
                        otherObjects.splice(i, 1);
                        this.destroy();

                      } else if (otherObjects[i].tag === "mothership") {
                        //mothership dmg
                        otherObjects[i].shieldHP -= 10;
                        console.log(otherObjects[i].shieldHP);
                        this.destroy();
                      } else if (otherObjects[i].tag === "playerCannon") {
                        otherObjects[0].hullHP -= 10;
                        otherObjects[i].destroy();
                        this.destroy();
                      }

                    }//end of checkIntersect
                  }//end of otherObjects alive
                }//end of for

              }//end of bullet alive
            };

            this.destroy = function() {
              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              this.alive = false;
              this.posX = -1000;
              this.posY = -1000;
            }
          }

          //main enemy script
          class enemyShip {
            constructor(x, y, velocityX, velocityY, width, height, tag) {
              this.posX = x;
              this.posY = y;
              this.velocityX = velocityX;
              this.velocityY = velocityY;
              this.width = width;
              this.height = height;
              this.tag = tag;
              this.alive = true;
              this.cooldown = false;


              this.shoot = this.shoot.bind(this);
              this.cooldownreset = this.cooldownreset.bind(this);
            }

            drawSelf() {
              ctx.drawImage(imageRepo.enemy1,
                this.posX, this.posY, this.width, this.height);
            }

            moveHorizontal() {
              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              if (randomInt(0,2) === 0) {
                this.posX += 30;
              } else {
                this.posX -= 30;
              }
              this.screenResets();
              ctx.drawImage(imageRepo.enemy1,
                this.posX, this.posY, this.width, this.height);
            }

            moveVertical() {
              let chancetoMoveForward = randomInt(0,10);
              let forwardVelocity = 0;
              if (chancetoMoveForward >= 9) {
                forwardVelocity = 30;
              }
              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              ctx.fillStyle = "white";
              this.posY += forwardVelocity;
              ctx.drawImage(imageRepo.enemy1,
                this.posX, this.posY, this.width, this.height);
            }

            cooldownreset() {
              this.cooldown = false;
            }


            shoot(source) {
              if (this.cooldown) {
                let cooldowntimer = randomInt(500, 8000);
                setTimeout(this.cooldownreset, cooldowntimer)
              } else {
                let nb = new bullet(
                  source.posX + 5, source.posY, 10, 6, 12);
                  nb.spawn(source.posX + 7, source.posY + 28, 10, 6, 12, "enemy1");
                  nb.drawSelf();
                  bulletList.push(nb);
                  this.cooldown = true;
              }
              // console.log(bulletList);
            }

            screenResets() {
              if (this.posX < 60)
              this.posX = 60;
              if (this.posX > 520)
              this.posX = 520;
              if (this.posY > 400)
              this.destroy();
            }


            destroy() {
              //create explosion
              let newexplo = new Explosion(this);
              newexplo.drawSelf();
              explosionList.push(newexplo);

              //clear self
              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              this.alive = false;
              this.posX = -1000;
              this.posY = -1000;
            }

          }//end of enemy ship

          class Explosion {
            constructor(source) {
              this.posX = source.posX;
              this.posY = source.posY;
              this.width = 40;
              this.height = 40;
              this.alive = true;
              this.timer  = 0;

              // this.timing = this.timing.bind(this);
              // this.timeToGo = this.timeToGo.bind(this);
              // this.destroy = this.destroy.bind(this);
            }

            drawSelf() {
              // ctx.drawImage(imageRepo.shieldSheet,
              // 0, 0, 300, 100,
              // this.posX - 20, this.posY - 60, this.width, this.height);
              ctx.drawImage(imageRepo.explosion,
                0,          0,        30,        37,
                this.posX, this.posY, this.width, this.height);
            }

            destroy() {
              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              this.alive = false;
              this.posX = -1000;
              this.posY = -1000;
            }
          }

          function updateShip() {
            //mothership
            // playerList[0].drawSelf();
            // playerList[0].drawShield();
            ctx.drawImage(imageRepo.mothershipImg,
            60, 308, 500, 220);
            ctx.drawImage(imageRepo.shieldSheet,
            0, 0, 300, 100,
            40, 258, 470, 200);
          }

          function updateBullets() {
            for (let i = 0; i < bulletList.length; i++) {

              if (bulletList[i].alive) {
                //if bullet is alive and still within play area...
                if (bulletList[i].posY > 0 && bulletList[i].posY < 400) {
                  ctx.clearRect(bulletList[i].posX, bulletList[i].posY,
                    bulletList[i].width, bulletList[i].height);
                  ctx.fillStyle = "orange";
                    if (bulletList[i].tag === "player") {
                      //check whether bullet source is
                      bulletList[i].posY -= 5;
                      bulletList[i].checkCollision(enemyList);
                    } else {
                      //check if bullet source is emeny
                      bulletList[i].posY += 2;
                      bulletList[i].checkCollision(playerList);
                    }
                  ctx.fillRect(bulletList[i].posX, bulletList[i].posY,
                  bulletList[i].width, bulletList[i].height);

                } else {
                  //if pos is going off, delete it
                  //splice removes from i position, 1 thing
                  bulletList[i].alive = false;
                  bulletList[i].destroy();
                  bulletList.splice(i, 1);
                }
              } else {
                //if its in the list but not alive...
                bulletList[i].destroy();
                bulletList.splice(i, 1);
              }
            }

          }

          function updateExplosions() {
            for (let i = 0; i < explosionList.length; i++) {
              if (explosionList[i].alive) {
                ctx.clearRect(explosionList[i].posX, explosionList[i].posY,
                  explosionList[i].width, explosionList[i].height);
                  ctx.drawImage(imageRepo.explosion,
                    0,          0,        30,        37,
                    explosionList[i].posX, explosionList[i].posY, explosionList[i].width, explosionList[i].height);
                    explosionList[i].timer += 1;
                    // console.log(explosionList[i].timer);
                    if (explosionList[i].timer >= 200) {
                      explosionList[i].destroy();
                      explosionList.splice(i, 1);
                    }
              } else {
                //if its in the list but not alive...
                explosionList[i].destroy();
                explosionList.splice(i, 1);
              }
            }
          }

          function enemyUpdate() {
            for (let i = 0; i < enemyList.length; i++) {
              if (enemyList[i].alive) {
                enemyList[i].moveHorizontal();
                enemyList[i].moveVertical();
              } else {
                //get rid of enemy from list
                enemyList.splice(i, 1);
              }
            }
          }

          function enemyAttack() {
            for (let i = 0; i < enemyList.length; i++) {
              if (enemyList[i].alive) {
                enemyList[i].shoot(enemyList[i]);
              }

            }
          }

          function randomSpawn() {
            if (enemyList.length < 12) {
              let randomX = randomInt(0, 10);
              let spawnXs = [60, 110, 160, 220, 270, 320, 370, 420, 470, 520]
              let newenemy = new enemyShip(spawnXs[randomX], 30,
                30, 30, 30, 30, "enemyShip");
                  newenemy.drawSelf();
                  enemyList.push(newenemy);

            }
          }

          function drawUI() {
            ctx_ui.font = "14px Calibri";
            ctx_ui.clearRect(0, 300, 100, 40);
            ctx_ui.fillText("Shield:", 0, 300);
            ctx_ui.fillText(playerList[0].shieldHP, 45, 300);
            ctx_ui.fillText("Hull:", 0, 320);
            ctx_ui.fillText(playerList[0].hullHP, 45, 320);
          }

        function setAllIntervals() {
          //update intervals
          window.setInterval(updateBullets, 16);
          window.setInterval(updateExplosions, 16);
          window.setInterval(updateShip, 16);
          window.setInterval(drawUI, 16);
          window.setInterval(randomSpawn, 3000);
          window.setInterval(enemyUpdate, 500);
          window.setInterval(enemyAttack, randomInt(500, 5000));


          //although I make them all rect, the ship & shield still don't work
          // window.setInterval(mothership.drawSelf, 16);
          // window.setInterval(mothership.drawShield, 16);

          //now that I updated cannon to die, this also stopped working
          //it clearly runs once but only once
          window.setInterval(updateCannon(playerList[1]), 16);

          //draw intervals
          //draw bg
          const bg = new Parallax();
          window.setInterval(bg.drawSelf, 16);



        }//end set all intervals

        function updateCannon(cannon) {
          let thisCannon = cannon;
          console.log("always updating");
          //it never goes in here
          if (!thisCannon.alive) {
            debugger
            thisCannon.deathtimer += 1;
            console.log(thisCannon.deathtimer);
            if (thisCannon.deathtimer >= 200) {
              thisCannon.respawn();
            }
          } else {
            //its alive
            thisCannon.drawSelf();

            //keypress handler
            //this is also basically the update() for ship
            document.addEventListener('keydown', (e) => {

              if (thisCannon.alive) {
                switch (e.keyCode) {

                  case 37:
                  //left
                  ctx.clearRect(thisCannon.posX, thisCannon.posY, thisCannon.width, thisCannon.height);
                  thisCannon.posX -= 20;
                  thisCannon.screenResets();
                  ctx.drawImage(imageRepo.cannonSheet,
                  0, 0, 90, 220,
                  thisCannon.posX, thisCannon.posY, thisCannon.width, thisCannon.height);
                  break;
                  case 39:
                  //right
                  ctx.clearRect(thisCannon.posX, thisCannon.posY, thisCannon.width, thisCannon.height);
                  thisCannon.posX += 20;
                  thisCannon.screenResets();
                  ctx.drawImage(imageRepo.cannonSheet,
                  0, 0, 90, 220,
                  thisCannon.posX, thisCannon.posY, thisCannon.width, thisCannon.height);
                  break;
                  case 32:
                  //spacebar shoot
                  e.preventDefault();
                  let nb = new bullet(
                    thisCannon.posX + 5, thisCannon.posY, 10, 6, 12);
                    nb.spawn(thisCannon.posX + 5, thisCannon.posY, 10, 6, 12, "player");
                    nb.drawSelf();
                    bulletList.push(nb);
                    // console.log(bulletList);
                    break;
                    //add another case for pause if time allows
                    default:
                  }

              }
            });
          }

        }

          // //keypress handler
          // //this is also basically the update() for ship
          // document.addEventListener('keydown', (e) => {
          //   ctx.fillStyle = 'gray';
          //   switch (e.keyCode) {
          //
          //     case 37:
          //     //left
          //     ctx.clearRect(cannon.posX, cannon.posY, cannon.width, cannon.height);
          //     cannon.posX -= 20;
          //     cannon.screenResets();
          //     ctx.fillRect(cannon.posX, cannon.posY, cannon.width, cannon.height);
          //     break;
          //     case 39:
          //     //right
          //     ctx.clearRect(cannon.posX, cannon.posY, cannon.width, cannon.height);
          //     cannon.posX += 20;
          //     cannon.screenResets();
          //     ctx.fillRect(cannon.posX, cannon.posY, cannon.width, cannon.height);
          //     break;
          //     case 32:
          //     //spacebar shoot
          //     e.preventDefault();
          //     let nb = new bullet(
          //     cannon.posX + 5, cannon.posY, 10, 6, 12);
          //     nb.spawn(cannon.posX + 5, cannon.posY, 10, 6, 12, "player");
          //     nb.drawSelf();
          //     bulletList.push(nb);
          //     // console.log(bulletList);
          //     break;
          //     //add another case for pause if time allows
          //     default:
          //   }
          // });



      })//end of DOMContentLoaded
    </script>
  </head>
  <body>
    <div class="content-container">
      <h1>MOTHERSHIP DOWN</h1>
      <div class="game-viewport">
          <canvas id="canvas-BG" height="400" width="600"></canvas>
          <canvas id="canvas" height="400" width="600" tabindex='1'></canvas>
          <canvas id="canvas-UI" height="400" width="600" z-index="1"></canvas>

      </div>
      <div class="icons">
        <a href="https://heinhtetps.github.io/"><i id="linker"class="fa fa-home fa-2x"></i></a>
        <a href="https://www.linkedin.com/in/heinhtetps/"><i id="linker"class="fa fa-linkedin fa-2x"></i></a>
        <a href="https://github.com/heinhtetPS"><i id="linker"class="fa fa-github fa-2x"></i></a>
        <a href="mailto: heinhtet.pyisoe@gmail.com"><i id="linker"class="fa fa-envelope fa-2x"></i></a>
      </div>
    </div>
    <p>&copy; 2017 Hein Htet Pyi Soe. All Rights Reserved.</p>
  </body>
</html>
