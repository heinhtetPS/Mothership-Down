<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Mothership Down!</title>
    <link rel="stylesheet" type="text/css" href="./assets/stylesheets/reset.css" />
    <link rel="stylesheet" type="text/css" href="./assets/stylesheets/mainpage.css" />
    <script>
      document.addEventListener('DOMContentLoaded', () => {

        //run once
        initialize();

        //run every frame
        window.setInterval(update, 16);
        window.setInterval(draw, 16);

        //custom interval updates
        window.setInterval(randomSpawn, 3000);
        window.setInterval(enemyUpdate, 500);




        function initialize() {
            //initialize canvas vars
          window.canvas = document.getElementById('canvas');
          window.ctx = canvas.getContext('2d');

          //initialize images
          window.imageRepo = new function() {
            this.mothershipImg = new Image();
            this.mothershipImg.src = "./assets/images/mainship.png";
          }

          //initialize mothership
          window.mothership = {
            posX: 60,
            posY: 355,
            width: 470,
            height: 100,
            tag: "playerShip",
            hp: 100,
            drawSelf: function() {
              // ctx.fillStyle = "purple";
              // ctx.fillRect(this.posX, this.posY, this.width, this.height);
              ctx.drawImage(imageRepo.mothershipImg,
              this.posX, this.posY, this.width, this.height)
            }
          }

          //initialize cannon vars
          window.cannon = {
            posX: canvas.width/2,
            posY: canvas.height - 70,
            width: 15,
            height: 30,
            hp: 10,
            tag: "playerCannon",
            drawSelf: function() {
              ctx.fillStyle = "gray";
              ctx.fillRect(this.posX, this.posY, this.width, this.height);
            }
          };



          //helper methods-----------------------

          //max is not included
          window.randomInt = function(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min)) + min;
          }

          //initialize spawner
          window.spawner = {
            // spawnEnemy: enemyShip.spawn(window.randomInt(30, 570), window.randomInt(30, 200)
            // enemyShip.defaultVelocityX, enemyShip.defaultVelocityY,
            // enemyShip.defaultWidth, enemyShip.defaultHeight),

          };

          //used with screen logic
          window.screenResets = {
            top: 0,
            bottom: 400,
            left: 0,
            right: 600
          }

          //list of bullets on screen
          window.bulletList = [];
          //list of enemies on screen
          //max is currently 12
          window.enemyList = [];
          //List of player cannons and mothership
          window.playerList = [];
          playerList.push(cannon);
          playerList.push(mothership);
        }
        //end initialize --------------------------


        function cannonScreenResets() {
          if (cannon.posX < window.screenResets.left)
          cannon.posX = 580;
          if (cannon.posX > window.screenResets.right)
          cannon.posX = 0;
        }

        //main bullet script
        function bullet(x, y, velocity, width, height) {
            this.alive = false;
            this.defaultWidth = 6;
            this.defaultHeight = 12;
            this.defaultVelocity = 5;
            this.tag = "";
            //decide the tag on spawn

            this.spawn = function(x, y, velocity, width, height, tag) {
              this.posX = x;
              this.posY = y;
              this.velocity = velocity;
              this.width = width;
              this.height = height;
              this.alive = true;
              this.tag = tag;
            }

            this.drawSelf = function() {

              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              ctx.fillStyle = "orange";
              ctx.fillRect(this.posX, this.posY, this.width, this.height);
            }

            function checkIntersect(obj1, obj2) {
              if (obj1.posX < obj2.posX + obj2.width &&
                obj1.posX + obj1.width > obj2.posX &&
                obj1.posY < obj2.posY + obj2.height &&
                obj1.height + obj1.posY > obj2.posY) {
                  return true;
              } else {
                return false;
              }
            }

            this.checkCollision = function(otherObjects) {
              if (this.alive) {

                for (let i = 0; i < otherObjects.length; i++) {

                  if (checkIntersect(this, otherObjects[i])) {
                    if (otherObjects[i].tag === "enemyShip") {
                      otherObjects[i].destroy();
                      otherObjects.splice(i, 1);
                      this.destroy();
                    } else {
                      otherObjects[i].hp -= 10;
                      this.destroy();
                    }

                  }
                }

              }
            };

            this.destroy = function() {
              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              this.alive = false;
              this.posX = -1000;
              this.posY = -1000;
            }
          }

          //main enemy script
          function enemyShip(x, y, velocityX, velocityY, width, height) {
            this.alive = false;
            this.defaultVelocityX = 20;
            this.defaultVelocityY = 20;
            this.defaultWidth = 30;
            this.defaultHeight = 30;
            this.tag = "enemyShip";

            this.spawn = function(x, y, velocityX, velocityY, width, height, tag) {
              this.posX = x;
              this.posY = y;
              this.velocityX = velocityX;
              this.velocityY = velocityY;
              this.width = width;
              this.height = height;
              this.tag = tag;
              this.alive = true;
            }

            this.drawSelf = function() {
              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              ctx.fillStyle = "white";
              ctx.fillRect(this.posX, this.posY, this.width, this.height);
            }

            this.moveHorizontal = function() {
              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              ctx.fillStyle = "white";
              if (randomInt(0,2) === 0) {
                this.posX += 30;
              } else {
                this.posX -= 30;
              }
              this.screenResets();
              ctx.fillRect(this.posX, this.posY, this.width, this.height);
            }

            this.moveVertical = function() {
              let chancetoMoveForward = randomInt(0,10);
              let forwardVelocity = 0;
              if (chancetoMoveForward >= 9) {
                forwardVelocity = 30;
                console.log(enemyList);
              }
              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              ctx.fillStyle = "white";
              this.posY += forwardVelocity;
              ctx.fillRect(this.posX, this.posY, this.width, this.height);
            }

            this.screenResets = function() {
              if (this.posX < 60)
              this.posX = 60;
              if (this.posX > 520)
              this.posX = 520;
              if (this.posY > 400)
              this.destroy();
            }


            this.destroy = function() {
              ctx.clearRect(this.posX, this.posY, this.width, this.height);
              this.alive = false;
              this.posX = -1000;
              this.posY = -1000;
            }

          }

        function update() {
          if (bulletList.length > 0)
          updateBullets();

        }

        //COLLISION & PROXIMITY
        function checkIntersect(obj1, obj2) {
          if (obj1.posX < obj2.posX + obj2.width &&
            obj1.posX + obj1.width > obj2.posX &&
            obj1.posY < obj2.posY + obj2.height &&
            obj1.height + obj1.posY > obj2.posY) {
              return true;
          } else {
            return false;
          }
        }


        //if bulletList is not empty, run this every frame
        //this is problematic because updating the pos needs to be seperated from drawing
        //if they're together, bullet stops executing velocity before it can become invalid
        //and undrawable
        function updateBullets() {
          for (let i = 0; i < bulletList.length; i++) {

            if (bulletList[i].alive) {
              //if bullet is alive and still within play area...
              if (bulletList[i].posY > 0) {
                ctx.clearRect(bulletList[i].posX, bulletList[i].posY,
                  bulletList[i].width, bulletList[i].height)
                bulletList[i].posY -= 5;
                ctx.fillStyle = "orange";
                ctx.fillRect(bulletList[i].posX, bulletList[i].posY,
                bulletList[i].width, bulletList[i].height)
                if (bulletList[i].tag === "player") {
                  bulletList[i].checkCollision(enemyList);
                } else {
                  bulletList[i].checkCollision(playerList);
                }
              } else {
                //if pos is going off, delete it
                //splice removes from i position, 1 thing
                bulletList[i].alive = false;
                bulletList[i].destroy();
                bulletList.splice(i, 1);
              }
            } else {
              //if its in the list but not alive...
              bulletList[i].destroy();
              bulletList.splice(i, 1);
            }
          }

        }
        //this isn't even running;
        function enemyUpdate() {
          for (let i = 0; i < enemyList.length; i++) {
            if (enemyList[i].alive) {
              enemyList[i].moveHorizontal();
              enemyList[i].moveVertical();
            } else {
              //get rid of enemy from list
              enemyList[i].splice(i, 1);
            }
          }
        }

        function randomSpawn() {
          if (enemyList.length < 12) {
            let randomX = randomInt(0, 10);
            let spawnXs = [60, 110, 160, 220, 270, 320, 370, 420, 470, 520]
            let newenemy = new enemyShip(spawnXs[randomX], 50,
              30, 30, 30, 30, "enemyShip");
              newenemy.spawn(spawnXs[randomX], 50,
                30, 30, 30, 30, "enemyShip");
                newenemy.drawSelf();
                enemyList.push(newenemy);

          }
        }

        function draw() {
          //draw mothership
          mothership.drawSelf();

          //draw main cannon
          cannon.drawSelf();

          //draw active enemies
          for (let i = 0; i < enemyList.length; i++) {
            enemyList[i].drawSelf();
          }

        }


        // let testnum = 60;
        //initialize keypress handler
        //this is also basically the update() for ship
        document.addEventListener('keydown', (e) => {
          ctx.fillStyle = 'gray';
          switch (e.keyCode) {
            // case 38:
            // //up
            //   y -= 1;
            //   ctx.fillRect(x, y, 20, 20);
            //   break;
            // case 40:
            //   //down
            //   y += 1;
            //   ctx.fillRect(x, y, 20, 20);
            //   break;
            case 37:
                //left
              ctx.clearRect(cannon.posX, cannon.posY, cannon.width, cannon.height);
              cannon.posX -= 20;
              cannonScreenResets();
              ctx.fillRect(cannon.posX, cannon.posY, cannon.width, cannon.height);
              break;
            case 39:
                //right
              ctx.clearRect(cannon.posX, cannon.posY, cannon.width, cannon.height);
              cannon.posX += 20;
              cannonScreenResets();
              ctx.fillRect(cannon.posX, cannon.posY, cannon.width, cannon.height);
              break;
            case 32:
                //spacebar shoot
                e.preventDefault();
                let nb = new bullet(
                  cannon.posX + 5, cannon.posY, 10, 6, 12);
                  nb.spawn(cannon.posX + 5, cannon.posY, 10, 6, 12, "player");
                  nb.drawSelf();
                  bulletList.push(nb);
                console.log(bulletList);
                break;

            default:

          }
        })

      })
    </script>
  </head>
  <body>
    <div class="content-container">
      <div class="game-viewport">
        <div class="bg-cutter">
          <div id="canvas-bg"></div>
          <canvas id="canvas" height="400" width="600" tabindex='1'></canvas>
        </div>
      </div>
    </div>
  </body>
</html>
